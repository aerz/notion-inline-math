// ==UserScript==
// @name Inline Math for Notion.so
// @version 1.0.0
// @match https://www.notion.so/*
// @grant GM_addStyle
// @require https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.js
// ==/UserScript==
!function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";n.r(e);var o=function(t){const e=document.querySelectorAll('span[style*="monospace"]');Array.prototype.slice.call(e).filter(t=>t.textContent.startsWith("math:")).forEach(e=>{const n=e.textContent.slice(5).trim();e=t?t(e):function(t){return t.style.color=null,t.style.background=null,t}(e),katex.render(n,e,{throwOnError:!1,font:"mathit"})})};var r={getMathBlocks:function(){const t=document.querySelectorAll('span[style*="monospace"]');return Array.prototype.slice.call(t).filter(t=>t.textContent.startsWith("math:"))},isToggleList:function(t){return"polygon"===t.target.nodeName||"triangle"===t.target.classList[0]||void 0!==t.target.attributes.role},createTooltipPreview:function(t,e){let n=document.createElement("div");return n.setAttribute("id","tooltip-inline-math"),n.classList.add("tooltip"),n.style=`top: ${e}px; left: ${t}px;`,n.innerHTML="<div>Math Inline Preview</div>",n},getTooltipPreview:function(){return document.getElementById("tooltip-inline-math")}};var i=function t(){if(r.getMathBlocks().length<1)return setTimeout(t,500),!1;o()};let l="",a=[],c={x:0,y:0};function u(){a.forEach(t=>t.remove());const t=r.getTooltipPreview();t&&t.remove(),a=[]}var d=function(t){"F2"!=t.key||t.ctrlKey||t.shiftKey||t.altKey||o()},s=function(t){const e=r.getMathBlocks();if(e.length<1)return!1;u();let n=r.createTooltipPreview(c.x,c.y);e.forEach(t=>{const e=t.textContent.slice(5).trim();let o=document.createElement("div");o.classList.add("tooltip__preview"),a.push(o),n.appendChild(o),katex.render(e,o,{throwOnError:!1,font:"mathit"})}),document.body.appendChild(n)},p=function(t){u(),o()},f=function(t){const e=r.getTooltipPreview();if(null===e)return!1;c.x=t.clientX,c.y=t.clientY,e.style=`top: ${c.y}px; left: ${c.x}px;`},y=function(t){r.isToggleList(t)&&setTimeout(o,500),window.location.href!==l&&(l=window.location.href,i())};GM_addStyle("\n  .notion-frame span .katex {\n    padding-right: 0 !important;\n  }\n\n  .tooltip {\n    color: white;\n    background-color: rgb(55, 53, 47);\n    border-radius: 8px;\n    padding: 10px;\n    position: absolute;\n    z-index: 999;\n  }\n\n  .tooltip__preview {\n    background-color: #eee;\n    color: black;\n    padding: 5px;\n    border-radius: 8px;\n    margin-top: 10px;\n  }\n"),window.addEventListener("keydown",d),window.addEventListener("keyup",s),window.addEventListener("focusout",p),window.addEventListener("mousemove",f),window.addEventListener("click",y),i()}]);